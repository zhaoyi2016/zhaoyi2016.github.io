<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>spline</title>
    <script src="https://code.highcharts.com/highcharts.src.js"></script>
    <script type="text/javascript">
        var data = []
    </script>
    <style>
        input[type="number"],
        textarea {
            background-color: #333333;
            color: white;
        }

        body {
            vertical-align: top;
            background: #333333;
            color: white;
        }
    </style>
</head>

<body>
    <div style="width: 40%; display: inline-block; vertical-align: top;">
        <textarea style="width: 90%; height: 100%; min-height: 50em;" id="dataText"></textarea>
        <div>
            几段数据：
            <input type="number" value=4 id="inputTypeHeight" />
            <input type="button" value="Apply" id="applyBtn" />
            <span id='loading'></span>
        </div>
    </div>
    <div id="container" style="width: 50%; display: inline-block; min-width: 310px; height: 400px; margin: 0 auto"></div>
    <script type="text/javascript">
        var data = []
    </script>
    <script type="text/javascript">
        var chart = Highcharts.chart('container', {
            chart: {
                // type: 'spline',
                backgroundColor: 'rgba(0, 0, 0, 0.0)',
            },
            title: {
                text: '呵呵哒曲线',
                style: {
                    color: 'rgba(255, 255, 255, 1.0)',
                }
            },
            subtitle: {
                text: '没有副标题',
                style: {
                    color: 'rgba(255, 255, 255, 0.8)',
                }
            },
            legend: {
                enabled: false
            },

            // xAxis: {
            //     type: 'datetime',
            //     dateTimeLabelFormats: { // don't display the dummy year
            //         month: '%e. %b',
            //         year: '%b'
            //     },
            //     title: {
            //         text: 'Date'
            //     }
            // },
            yAxis: [{
                title: {
                    text: '建筑高度'
                },
            }, {
                lineWidth: 1,
                opposite: true,
                title: {
                    text: 'Secondary Axis'
                },
                // labels: {
                //     formatter: function () {
                //         var labales = {
                //             7: '低',
                //             9: '中低',
                //             11: '中高',
                //             13: '高',
                //         }
                //         console.log(this.value)
                //         return labales[this.value];
                //     }
                // }
            }],
            tooltip: {
                enabled: false,
                // shared: true,
                // useHTML: true,
                // headerFormat: '<b>svf: {point.x} ~ {point.x} + {series.name}</b><br>',
                // pointFormat: '{point.y}'
                // formatter: function () {
                //     var fromSvf = this.x.toFixed(2), toSvf = (this.x + parseFloat(this.series.name.replace('step:  ', ''))).toFixed(2);
                //     var count = this.y;
                //     return '<b>svf: ' + fromSvf + ' ~ ' + toSvf + '</b><br>' +
                //         '' + count + ''
                // }
            },

            plotOptions: {
                line: {
                    marker: {
                        enabled: false
                    }
                },
                spline: {
                    marker: {
                        enabled: false
                    }
                }
            },

            // colors: ['#6CF', '#39F', '#06C', '#036', '#000'],

            series: data
        });
    </script>
    <script type="text/javascript">
        function loading(i, n) {
            console.log('Loading: ' + i);
            if (i >= 0) {
                document.getElementById("loading").innerText = i + " / " + n;
            } else {
                document.getElementById("loading").innerText = "";
            }
        }
        function parseLine(line) {
            try {
                var x = line.split('\t');
                var y = x[1].substring(1, x[1].length - 1).split(', ').map(i => parseInt(i));
                return [x[0], y];
            } catch (err) {
                console.log(err);
                return undefined;
            }
        }
        document.getElementById('applyBtn').addEventListener('click', function (evt) {
            var numTypeHeight = parseInt(document.getElementById('inputTypeHeight').value);
            var finishedCounter = 0;
            var text = document.getElementById('dataText').value;
            var arr = text.split('\n');
            var data = arr.map(a => parseLine(a)).filter(a => !!a);
            loading(0, data.length);
            data.sort(function (a, b) {
                return a[0] - b[0];
            });
            var minHeight = 100, maxHeight = -1;
            data.forEach(d => {
                d[1].forEach(x => {
                    minHeight = Math.min(minHeight, x);
                    maxHeight = Math.max(maxHeight, x);
                });
            });
            console.log(data)
            var colorPicker = ['rgba(255, 0, 0, 0.2)', 'rgba(255, 255, 0, 0.2)', 'rgba(0, 255, 0, 0.2)', 'rgba(0, 255, 255, 0.2)', 'rgba(0, 0, 255, 0.2)'];
            var promises = data.map((d, index) => {
                var t = Math.floor(index / data.length * numTypeHeight);
                var th = t * ((maxHeight - minHeight) / (numTypeHeight - 1)) + minHeight;
                d[1].push(th);
                return new Promise(function (resolve, reject) {
                    setTimeout(function () {
                        chart.addSeries({
                            data: d[1],
                            color: colorPicker[t],
                            lineWidth: 1,
                        });
                        finishedCounter += 1;
                        loading(finishedCounter, data.length);
                        resolve();
                    }, 100);
                });
            });
            Promise.all(promises).then(function () {
                loading(-1);
            });
        });
    </script>
</body>

</html>
